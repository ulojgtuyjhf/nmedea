<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nmedea ‚Äî Sign In</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,700;9..40,800&display=swap" rel="stylesheet">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family:'DM Sans',sans-serif;
            background:#f3f3ee;
            color:#0b0b0b;
            min-height:100dvh;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            padding:24px;
        }

        .screen {
            display:none;
            width:100%;
            max-width:360px;
            flex-direction:column;
            align-items:center;
            gap:20px;
            animation:fadeUp 0.3s ease;
        }
        .screen.active { display:flex; }

        @keyframes fadeUp {
            from { opacity:0; transform:translateY(12px); }
            to   { opacity:1; transform:translateY(0); }
        }

        .logo {
            font-family:'Bebas Neue',sans-serif;
            font-size:36px;
            letter-spacing:6px;
            color:#0b0b0b;
        }

        .tagline {
            font-size:11px;
            letter-spacing:3px;
            text-transform:uppercase;
            color:rgba(11,11,11,0.35);
            margin-top:-16px;
            text-align:center;
        }

        /* STEPS */
        .steps { display:flex; align-items:center; width:100%; }

        .step-dot {
            width:28px; height:28px;
            border-radius:50%;
            background:rgba(11,11,11,0.1);
            display:flex; align-items:center; justify-content:center;
            font-size:11px; font-weight:800;
            color:rgba(11,11,11,0.3);
            flex-shrink:0;
            transition:all 0.3s;
        }
        .step-dot.active { background:#0b0b0b; color:#f3f3ee; }
        .step-dot.done   { background:#16a34a; color:#fff; }

        .step-line {
            flex:1; height:2px;
            background:rgba(11,11,11,0.1);
            transition:background 0.3s;
        }
        .step-line.done { background:#16a34a; }

        /* CARD */
        .card {
            width:100%;
            background:#fff;
            border-radius:16px;
            padding:28px 24px;
            display:flex;
            flex-direction:column;
            gap:16px;
            box-shadow:0 2px 24px rgba(11,11,11,0.07);
        }

        .card-title {
            font-family:'Bebas Neue',sans-serif;
            font-size:22px; letter-spacing:3px;
            color:#0b0b0b;
        }

        .card-sub {
            font-size:13px;
            color:rgba(11,11,11,0.45);
            margin-top:-10px;
            line-height:1.5;
        }

        .field { display:flex; flex-direction:column; gap:6px; }

        label {
            font-size:11px; letter-spacing:2px;
            text-transform:uppercase;
            color:rgba(11,11,11,0.4);
            font-weight:700;
        }

        .input-wrap { position:relative; }

        input[type=text],
        input[type=email],
        input[type=password],
        input[type=tel] {
            width:100%;
            padding:14px 16px;
            background:#f3f3ee;
            border:1.5px solid transparent;
            border-radius:10px;
            font-family:'DM Sans',sans-serif;
            font-size:15px;
            color:#0b0b0b;
            outline:none;
            transition:border-color 0.2s, background 0.2s;
        }
        input:focus { border-color:#0b0b0b; background:#fff; }
        input::placeholder { color:rgba(11,11,11,0.25); }
        input.has-toggle { padding-right:48px; }

        /* eye toggle */
        .eye-btn {
            position:absolute;
            right:14px; top:50%;
            transform:translateY(-50%);
            background:none; border:none;
            cursor:pointer;
            color:rgba(11,11,11,0.35);
            font-size:16px;
            padding:4px;
            line-height:1;
        }

        /* PASSWORD STRENGTH */
        .strength-bar {
            display:flex; gap:4px; margin-top:2px;
        }
        .strength-seg {
            flex:1; height:3px; border-radius:4px;
            background:rgba(11,11,11,0.1);
            transition:background 0.3s;
        }
        .strength-label {
            font-size:11px; letter-spacing:1px;
            margin-top:2px;
            min-height:14px;
        }

        /* SUGGEST PASSWORD */
        .suggest-btn {
            display:flex; align-items:center; gap:6px;
            background:rgba(11,11,11,0.04);
            border:1.5px dashed rgba(11,11,11,0.15);
            border-radius:8px;
            padding:10px 14px;
            cursor:pointer;
            font-family:'DM Sans',sans-serif;
            font-size:12px;
            color:rgba(11,11,11,0.5);
            letter-spacing:0.5px;
            width:100%;
            text-align:left;
            transition:all 0.2s;
        }
        .suggest-btn:hover {
            border-color:rgba(11,11,11,0.3);
            color:#0b0b0b;
            background:rgba(11,11,11,0.07);
        }
        .suggest-btn .key-icon { font-size:14px; }

        .suggested-pw {
            display:none;
            background:rgba(11,11,11,0.04);
            border:1.5px solid rgba(11,11,11,0.1);
            border-radius:8px;
            padding:10px 14px;
            font-size:13px;
            font-weight:700;
            letter-spacing:1px;
            color:#0b0b0b;
            word-break:break-all;
            cursor:pointer;
            transition:background 0.2s;
        }
        .suggested-pw:hover { background:rgba(11,11,11,0.08); }
        .suggested-pw.visible { display:block; }

        .pw-hint {
            font-size:11px;
            color:rgba(11,11,11,0.35);
            text-align:center;
        }

        /* PHONE */
        .phone-row { display:flex; gap:8px; }

        .country-code {
            padding:14px 10px;
            background:#f3f3ee;
            border:1.5px solid transparent;
            border-radius:10px;
            font-family:'DM Sans',sans-serif;
            font-size:15px;
            color:#0b0b0b;
            outline:none;
            width:76px;
            flex-shrink:0;
            transition:border-color 0.2s;
        }
        .country-code:focus { border-color:#0b0b0b; }

        /* OTP */
        .otp-row { display:flex; gap:8px; justify-content:center; }

        .otp-box {
            width:44px; height:52px;
            background:#f3f3ee;
            border:1.5px solid transparent;
            border-radius:10px;
            font-family:'DM Sans',sans-serif;
            font-size:20px; font-weight:700;
            color:#0b0b0b;
            text-align:center;
            outline:none;
            transition:border-color 0.2s, background 0.2s;
        }
        .otp-box:focus { border-color:#0b0b0b; background:#fff; }

        /* BUTTONS */
        .btn {
            width:100%; padding:16px;
            background:#0b0b0b; color:#f3f3ee;
            border:none; border-radius:10px;
            font-family:'DM Sans',sans-serif;
            font-size:13px; font-weight:800;
            letter-spacing:2px; text-transform:uppercase;
            cursor:pointer;
            transition:opacity 0.2s, transform 0.1s;
            margin-top:4px;
        }
        .btn:hover { opacity:0.85; }
        .btn:active { transform:scale(0.98); }
        .btn:disabled { opacity:0.35; cursor:not-allowed; transform:none; }

        .btn-ghost {
            background:transparent;
            color:rgba(11,11,11,0.45);
            border:1.5px solid rgba(11,11,11,0.12);
        }

        .btn-back {
            background:transparent; color:rgba(11,11,11,0.4);
            border:none; font-size:12px; letter-spacing:1px;
            cursor:pointer; display:flex; align-items:center; gap:4px;
            padding:0; width:auto;
            font-family:'DM Sans',sans-serif;
        }

        .divider {
            display:flex; align-items:center; gap:12px;
        }
        .divider span {
            font-size:11px; letter-spacing:2px;
            text-transform:uppercase;
            color:rgba(11,11,11,0.25);
            white-space:nowrap;
        }
        .divider::before,.divider::after {
            content:''; flex:1; height:1px;
            background:rgba(11,11,11,0.1);
        }

        .free-badge {
            display:inline-flex; align-items:center; gap:6px;
            background:#0b0b0b; color:#f3f3ee;
            font-size:10px; letter-spacing:2px;
            text-transform:uppercase; font-weight:800;
            padding:6px 14px; border-radius:100px;
        }

        .dot {
            width:6px; height:6px; background:#22c55e;
            border-radius:50%;
            animation:pulse 1.5s infinite;
            flex-shrink:0;
        }
        @keyframes pulse {
            0%,100%{opacity:1;transform:scale(1);}
            50%{opacity:0.4;transform:scale(0.7);}
        }

        .msg { font-size:13px; text-align:center; min-height:18px; }
        .msg.ok  { color:#16a34a; }
        .msg.err { color:#dc2626; }
        .msg.info { color:#2563eb; }

        .resend { font-size:12px; color:rgba(11,11,11,0.4); text-align:center; }
        .resend span { color:#0b0b0b; font-weight:700; cursor:pointer; border-bottom:1px solid #0b0b0b; }

        .spinner {
            display:inline-block; width:14px; height:14px;
            border:2px solid rgba(243,243,238,0.3);
            border-top-color:#f3f3ee;
            border-radius:50%;
            animation:spin 0.6s linear infinite;
            vertical-align:middle; margin-right:6px;
        }
        @keyframes spin { to{transform:rotate(360deg);} }

        .success-icon {
            width:64px; height:64px; background:#16a34a;
            border-radius:50%;
            display:flex; align-items:center; justify-content:center;
            font-size:28px; color:white;
            animation:popIn 0.4s cubic-bezier(0.175,0.885,0.32,1.275);
        }
        @keyframes popIn {
            from{transform:scale(0);opacity:0;}
            to{transform:scale(1);opacity:1;}
        }

        .forgot-link {
            font-size:12px; color:rgba(11,11,11,0.4);
            cursor:pointer; text-align:right;
        }
        .forgot-link:hover { color:#0b0b0b; }

        #recaptcha-container { display:none; }

        /* requirements list */
        .req-list {
            display:flex; flex-direction:column; gap:4px;
            margin-top:2px;
        }
        .req {
            display:flex; align-items:center; gap:6px;
            font-size:11px; color:rgba(11,11,11,0.4);
            transition:color 0.2s;
        }
        .req.met { color:#16a34a; }
        .req .req-dot {
            width:6px; height:6px; border-radius:50%;
            background:rgba(11,11,11,0.15);
            flex-shrink:0;
            transition:background 0.2s;
        }
        .req.met .req-dot { background:#16a34a; }
    </style>
</head>
<body>

<!-- ‚ïê‚ïê LOGIN ‚ïê‚ïê -->
<div class="screen active" id="s-login">
    <div class="logo">nmedea</div>
    <div class="tagline">Your internet. Your way.</div>
    <div class="card">
        <div class="card-title">Welcome Back</div>
        <div class="card-sub">Sign in to your account.</div>
        <div class="field">
            <label>Email</label>
            <input type="email" id="l-email" placeholder="you@example.com" autocomplete="email"/>
        </div>
        <div class="field">
            <label>Password</label>
            <div class="input-wrap">
                <input type="password" id="l-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="has-toggle" autocomplete="current-password"/>
                <button class="eye-btn" onclick="toggleEye('l-pass',this)" type="button">üëÅ</button>
            </div>
        </div>
        <div class="forgot-link" onclick="show('s-forgot')">Forgot password?</div>
        <button class="btn" id="l-btn" onclick="doLogin()">Sign In</button>
        <div class="divider"><span>new to nmedea</span></div>
        <button class="btn btn-ghost" onclick="show('s-reg1')">Create Account</button>
    </div>
    <div class="msg" id="l-msg"></div>
</div>

<!-- ‚ïê‚ïê REGISTER STEP 1 ‚ïê‚ïê -->
<div class="screen" id="s-reg1">
    <div class="logo">nmedea</div>
    <div class="tagline">Create your account</div>
    <div class="steps">
        <div class="step-dot active">1</div>
        <div class="step-line"></div>
        <div class="step-dot">2</div>
        <div class="step-line"></div>
        <div class="step-dot">3</div>
    </div>
    <div class="card">
        <div class="card-title">Your Details</div>
        <div class="card-sub">Start with your basic info.</div>
        <div class="field">
            <label>Full Name</label>
            <input type="text" id="r-name" placeholder="Your full name" autocomplete="name"/>
        </div>
        <div class="field">
            <label>Email</label>
            <input type="email" id="r-email" placeholder="you@example.com" autocomplete="email"/>
        </div>
        <button class="btn" id="r1-btn" onclick="doStep1()">Continue</button>
    </div>
    <div class="msg" id="r1-msg"></div>
    <button class="btn-back" onclick="show('s-login')">‚Üê Back to Sign In</button>
</div>

<!-- ‚ïê‚ïê REGISTER STEP 2 ‚ïê‚ïê -->
<div class="screen" id="s-reg2">
    <div class="logo">nmedea</div>
    <div class="tagline">Create your account</div>
    <div class="steps">
        <div class="step-dot done">‚úì</div>
        <div class="step-line done"></div>
        <div class="step-dot active">2</div>
        <div class="step-line"></div>
        <div class="step-dot">3</div>
    </div>
    <div class="card">
        <div class="card-title">Create Password</div>
        <div class="card-sub">We recommend using a strong password.</div>

        <!-- Suggest password -->
        <button class="suggest-btn" onclick="generatePassword()" type="button">
            <span class="key-icon">üîë</span>
            Suggest a strong password
        </button>
        <div class="suggested-pw" id="suggested-pw" onclick="useSuggestedPw()"></div>
        <div class="pw-hint" id="pw-hint" style="display:none;">Tap to use this password ‚Äî it will be saved on your device</div>

        <div class="field">
            <label>Password</label>
            <div class="input-wrap">
                <input type="password" id="r-pass" placeholder="Min 8 characters" class="has-toggle" autocomplete="new-password" oninput="checkStrength(this.value)"/>
                <button class="eye-btn" onclick="toggleEye('r-pass',this)" type="button">üëÅ</button>
            </div>
            <!-- Strength bar -->
            <div class="strength-bar">
                <div class="strength-seg" id="seg1"></div>
                <div class="strength-seg" id="seg2"></div>
                <div class="strength-seg" id="seg3"></div>
                <div class="strength-seg" id="seg4"></div>
            </div>
            <div class="strength-label" id="strength-label"></div>
            <!-- Requirements -->
            <div class="req-list">
                <div class="req" id="req-len"><div class="req-dot"></div>At least 8 characters</div>
                <div class="req" id="req-upper"><div class="req-dot"></div>One uppercase letter</div>
                <div class="req" id="req-num"><div class="req-dot"></div>One number</div>
                <div class="req" id="req-sym"><div class="req-dot"></div>One symbol (!@#$...)</div>
            </div>
        </div>

        <div class="field">
            <label>Confirm Password</label>
            <div class="input-wrap">
                <input type="password" id="r-pass2" placeholder="Repeat password" class="has-toggle" autocomplete="new-password"/>
                <button class="eye-btn" onclick="toggleEye('r-pass2',this)" type="button">üëÅ</button>
            </div>
        </div>

        <button class="btn" id="r2-btn" onclick="doStep2()">Continue</button>
    </div>
    <div class="msg" id="r2-msg"></div>
    <button class="btn-back" onclick="show('s-reg1')">‚Üê Back</button>
</div>

<!-- ‚ïê‚ïê REGISTER STEP 3 ‚ïê‚ïê -->
<div class="screen" id="s-reg3">
    <div class="logo">nmedea</div>
    <div class="tagline">One last step</div>
    <div class="steps">
        <div class="step-dot done">‚úì</div>
        <div class="step-line done"></div>
        <div class="step-dot done">‚úì</div>
        <div class="step-line done"></div>
        <div class="step-dot active">3</div>
    </div>
    <div class="card">
        <div class="card-title">Verify Phone</div>
        <div class="card-sub">Protects your free trial. One number = one free trial. SA numbers supported.</div>
        <div class="field">
            <label>Phone Number</label>
            <div class="phone-row">
                <input class="country-code" type="text" id="r-code" value="+27" maxlength="4"/>
                <input type="tel" id="r-phone" placeholder="81 234 5678" style="flex:1;" oninput="formatSAPhone(this)"/>
            </div>
            <div style="font-size:11px;color:rgba(11,11,11,0.35);margin-top:2px;">Format: 081 234 5678 or 0821234567</div>
        </div>
        <button class="btn" id="r3-btn" onclick="doSendOTP()">Send Verification Code</button>
    </div>
    <div class="msg" id="r3-msg"></div>
    <button class="btn-back" onclick="show('s-reg2')">‚Üê Back</button>
    <div id="recaptcha-container"></div>
</div>

<!-- ‚ïê‚ïê OTP ‚ïê‚ïê -->
<div class="screen" id="s-otp">
    <div class="logo">nmedea</div>
    <div class="tagline">Enter your code</div>
    <div class="card">
        <div class="card-title">Check Your SMS</div>
        <div class="card-sub" id="otp-sub">We sent a 6-digit code to your number.</div>
        <div class="field">
            <label>Verification Code</label>
            <div class="otp-row">
                <input class="otp-box" maxlength="1" type="tel" id="o1"/>
                <input class="otp-box" maxlength="1" type="tel" id="o2"/>
                <input class="otp-box" maxlength="1" type="tel" id="o3"/>
                <input class="otp-box" maxlength="1" type="tel" id="o4"/>
                <input class="otp-box" maxlength="1" type="tel" id="o5"/>
                <input class="otp-box" maxlength="1" type="tel" id="o6"/>
            </div>
        </div>
        <button class="btn" id="otp-btn" onclick="doVerifyOTP()">Verify & Create Account</button>
        <div id="otp-timer" style="font-size:12px;text-align:center;color:rgba(11,11,11,0.4);"></div>
    </div>
    <div class="msg" id="otp-msg"></div>
    <div class="resend" id="resend-wrap" style="display:none;">Didn't receive it? <span onclick="doSendOTP()">Resend code</span></div>
    <button class="btn-back" onclick="show('s-reg3')">‚Üê Change Number</button>
</div>

<!-- ‚ïê‚ïê SUCCESS ‚ïê‚ïê -->
<div class="screen" id="s-success">
    <div class="success-icon">‚úì</div>
    <div class="logo">nmedea</div>
    <div class="tagline">You're all set!</div>
    <div class="card" style="text-align:center;gap:12px;">
        <div class="card-title">Welcome Aboard</div>
        <div class="card-sub">Your 3 hours of free internet starts now. Enjoy!</div>
        <div class="free-badge" style="margin:4px auto;">
            <span class="dot"></span>
            3 hours free ‚Äî starting now
        </div>
        <button class="btn" onclick="location.replace('dashboard.html')" style="margin-top:8px;">Go to Dashboard</button>
    </div>
</div>

<!-- ‚ïê‚ïê FORGOT ‚ïê‚ïê -->
<div class="screen" id="s-forgot">
    <div class="logo">nmedea</div>
    <div class="tagline">Reset your password</div>
    <div class="card">
        <div class="card-title">Forgot Password</div>
        <div class="card-sub">Enter your email and we'll send a reset link.</div>
        <div class="field">
            <label>Email</label>
            <input type="email" id="f-email" placeholder="you@example.com"/>
        </div>
        <button class="btn" id="f-btn" onclick="doForgot()">Send Reset Link</button>
        <button class="btn btn-ghost" onclick="show('s-login')">Back to Sign In</button>
    </div>
    <div class="msg" id="f-msg"></div>
</div>

<!-- ‚ïê‚ïê SCRIPTS ‚ïê‚ïê -->
<script>
    // ‚îÄ‚îÄ SCREEN SWITCH ‚îÄ‚îÄ
    window.show = id => {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    };

    // ‚îÄ‚îÄ EYE TOGGLE ‚îÄ‚îÄ
    window.toggleEye = (inputId, btn) => {
        const el = document.getElementById(inputId);
        if (el.type === 'password') { el.type = 'text'; btn.textContent = 'üôà'; }
        else { el.type = 'password'; btn.textContent = 'üëÅ'; }
    };

    // ‚îÄ‚îÄ SA PHONE FORMAT ‚îÄ‚îÄ
    window.formatSAPhone = el => {
        let v = el.value.replace(/\D/g,'');
        if (v.startsWith('0')) v = v.substring(1); // remove leading 0 since +27 adds it
        el.value = v;
    };

    // ‚îÄ‚îÄ PASSWORD GENERATOR ‚îÄ‚îÄ
    const chars = {
        upper: 'ABCDEFGHJKLMNPQRSTUVWXYZ',
        lower: 'abcdefghjkmnpqrstuvwxyz',
        nums:  '23456789',
        syms:  '!@#$%&*?'
    };

    window.generatePassword = () => {
        const all = chars.upper + chars.lower + chars.nums + chars.syms;
        let pw = '';
        pw += chars.upper[Math.floor(Math.random()*chars.upper.length)];
        pw += chars.lower[Math.floor(Math.random()*chars.lower.length)];
        pw += chars.nums[Math.floor(Math.random()*chars.nums.length)];
        pw += chars.syms[Math.floor(Math.random()*chars.syms.length)];
        for (let i=4; i<14; i++) pw += all[Math.floor(Math.random()*all.length)];
        pw = pw.split('').sort(()=>Math.random()-0.5).join('');

        const el = document.getElementById('suggested-pw');
        el.textContent = pw;
        el.classList.add('visible');
        document.getElementById('pw-hint').style.display = 'block';

        // Store temporarily
        window._suggestedPw = pw;
    };

    window.useSuggestedPw = () => {
        if (!window._suggestedPw) return;
        const p1 = document.getElementById('r-pass');
        const p2 = document.getElementById('r-pass2');
        p1.value = window._suggestedPw;
        p2.value = window._suggestedPw;
        p1.type  = 'text';
        p2.type  = 'text';
        checkStrength(window._suggestedPw);

        // Save to device (IndexedDB via localStorage)
        try {
            const saved = JSON.parse(localStorage.getItem('nmedea_saved_pws') || '[]');
            saved.unshift({ pw: window._suggestedPw, date: new Date().toISOString() });
            localStorage.setItem('nmedea_saved_pws', JSON.stringify(saved.slice(0,5)));
        } catch(e) {}

        document.getElementById('pw-hint').textContent = '‚úì Password saved on your device';
        document.getElementById('pw-hint').style.color = '#16a34a';
    };

    // ‚îÄ‚îÄ STRENGTH CHECKER ‚îÄ‚îÄ
    window.checkStrength = pw => {
        const segs   = [1,2,3,4].map(i => document.getElementById('seg'+i));
        const label  = document.getElementById('strength-label');
        const reqLen  = document.getElementById('req-len');
        const reqUp   = document.getElementById('req-upper');
        const reqNum  = document.getElementById('req-num');
        const reqSym  = document.getElementById('req-sym');

        const hasLen  = pw.length >= 8;
        const hasUp   = /[A-Z]/.test(pw);
        const hasNum  = /[0-9]/.test(pw);
        const hasSym  = /[!@#$%^&*?_\-+=]/.test(pw);

        reqLen.classList.toggle('met', hasLen);
        reqUp.classList.toggle('met', hasUp);
        reqNum.classList.toggle('met', hasNum);
        reqSym.classList.toggle('met', hasSym);

        const score = [hasLen, hasUp, hasNum, hasSym].filter(Boolean).length;

        const colors = ['#ef4444','#f97316','#eab308','#16a34a'];
        const labels = [
            { text:'Too weak', color:'#ef4444' },
            { text:'Weak',     color:'#f97316' },
            { text:'Fair',     color:'#eab308' },
            { text:'Strong ‚úì', color:'#16a34a' }
        ];

        segs.forEach((seg, i) => {
            seg.style.background = i < score ? colors[score-1] : 'rgba(11,11,11,0.1)';
        });

        if (pw.length === 0) {
            label.textContent = '';
            label.style.color = '';
        } else {
            label.textContent = labels[score-1]?.text || '';
            label.style.color = labels[score-1]?.color || '';
        }
    };

    // ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
    const setBtn = (id, loading, text) => {
        const b = document.getElementById(id);
        b.disabled = loading;
        b.innerHTML = loading ? '<span class="spinner"></span>Please wait...' : text;
    };

    const msg = (id, text, type) => {
        const el = document.getElementById(id);
        el.textContent = text;
        el.className = 'msg ' + (type||'');
    };

    // ‚îÄ‚îÄ OTP TIMER ‚îÄ‚îÄ
    let otpTimerInterval = null;

    function startOTPTimer() {
        let secs = 60;
        const timerEl = document.getElementById('otp-timer');
        const resendEl = document.getElementById('resend-wrap');
        resendEl.style.display = 'none';

        clearInterval(otpTimerInterval);
        otpTimerInterval = setInterval(() => {
            secs--;
            timerEl.textContent = `Resend available in ${secs}s`;
            if (secs <= 0) {
                clearInterval(otpTimerInterval);
                timerEl.textContent = '';
                resendEl.style.display = 'block';
            }
        }, 1000);
    }

    // ‚îÄ‚îÄ OTP BOXES ‚îÄ‚îÄ
    document.querySelectorAll('.otp-box').forEach((box, i, arr) => {
        box.addEventListener('input', () => {
            box.value = box.value.replace(/\D/g,'');
            if (box.value && i < arr.length-1) arr[i+1].focus();
            const code = Array.from(arr).map(b=>b.value).join('');
            if (code.length === 6) window.doVerifyOTP();
        });
        box.addEventListener('keydown', e => {
            if (e.key==='Backspace' && !box.value && i > 0) arr[i-1].focus();
        });
        // Handle paste
        box.addEventListener('paste', e => {
            e.preventDefault();
            const paste = (e.clipboardData||window.clipboardData).getData('text').replace(/\D/g,'');
            paste.split('').forEach((ch,j) => { if(arr[i+j]) arr[i+j].value = ch; });
            const last = Math.min(i+paste.length-1, arr.length-1);
            arr[last].focus();
            const code = Array.from(arr).map(b=>b.value).join('');
            if (code.length === 6) window.doVerifyOTP();
        });
    });

    // Enter key support
    document.addEventListener('keydown', e => {
        if (e.key !== 'Enter') return;
        const id = document.querySelector('.screen.active')?.id;
        if (id==='s-login')  window.doLogin();
        if (id==='s-reg1')   window.doStep1();
        if (id==='s-reg2')   window.doStep2();
        if (id==='s-reg3')   window.doSendOTP();
        if (id==='s-forgot') window.doForgot();
    });
</script>

<script type="module">
import { initializeApp }
    from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import {
    getAuth,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    updateProfile,
    sendPasswordResetEmail,
    onAuthStateChanged,
    RecaptchaVerifier,
    signInWithPhoneNumber
} from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import {
    getFirestore,
    doc, setDoc, collection,
    where, query, getDocs,
    enableIndexedDbPersistence
} from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

const app = initializeApp({
    apiKey:            "AIzaSyBreKi86gv26Eig7hym4WFhAB70VbVWW5g",
    authDomain:        "checkers-225fb.firebaseapp.com",
    projectId:         "checkers-225fb",
    storageBucket:     "checkers-225fb.firebasestorage.app",
    messagingSenderId: "75322611034",
    appId:             "1:75322611034:web:d3725be1ae7b640b408f63"
});

const auth = getAuth(app);
const db   = getFirestore(app);

// Enable offline persistence
enableIndexedDbPersistence(db).catch(()=>{});

// If already logged in ‚Üí dashboard
onAuthStateChanged(auth, u => {
    if (u) {
        // Save user info locally for offline use
        try {
            localStorage.setItem('nmedea_user', JSON.stringify({
                uid:   u.uid,
                email: u.email,
                name:  u.displayName
            }));
        } catch(e) {}
        location.replace('dashboard.html');
    }
});

let regData = {};
let confirmResult = null;

const setBtn = (id, loading, text) => {
    const b = document.getElementById(id);
    b.disabled = loading;
    b.innerHTML = loading ? '<span class="spinner"></span>Please wait...' : text;
};

const msg = (id, text, type) => {
    const el = document.getElementById(id);
    el.textContent = text;
    el.className = 'msg ' + (type||'');
};

// ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ
window.doLogin = async () => {
    const email = document.getElementById('l-email').value.trim();
    const pass  = document.getElementById('l-pass').value;
    if (!email||!pass) { msg('l-msg','Please fill in all fields.','err'); return; }
    setBtn('l-btn', true, 'Sign In');
    try {
        await signInWithEmailAndPassword(auth, email, pass);
    } catch(e) {
        const m = {
            'auth/invalid-credential':  'Invalid email or password.',
            'auth/user-not-found':      'No account found.',
            'auth/wrong-password':      'Incorrect password.',
            'auth/too-many-requests':   'Too many attempts. Please wait.'
        };
        msg('l-msg', m[e.code]||'Login failed. Try again.', 'err');
        setBtn('l-btn', false, 'Sign In');
    }
};

// ‚îÄ‚îÄ STEP 1 ‚îÄ‚îÄ
window.doStep1 = () => {
    const name  = document.getElementById('r-name').value.trim();
    const email = document.getElementById('r-email').value.trim();
    if (!name)              { msg('r1-msg','Please enter your name.','err'); return; }
    if (!email.includes('@')){ msg('r1-msg','Please enter a valid email.','err'); return; }
    regData.name  = name;
    regData.email = email;
    show('s-reg2');
};

// ‚îÄ‚îÄ STEP 2 ‚îÄ‚îÄ
window.doStep2 = () => {
    const pass  = document.getElementById('r-pass').value;
    const pass2 = document.getElementById('r-pass2').value;

    const hasLen  = pass.length >= 8;
    const hasUp   = /[A-Z]/.test(pass);
    const hasNum  = /[0-9]/.test(pass);
    const hasSym  = /[!@#$%^&*?_\-+=]/.test(pass);

    if (!hasLen||!hasUp||!hasNum||!hasSym) {
        msg('r2-msg','Please meet all password requirements.','err');
        return;
    }
    if (pass !== pass2) { msg('r2-msg',"Passwords don't match.",'err'); return; }
    regData.pass = pass;
    show('s-reg3');
};

// ‚îÄ‚îÄ STEP 3 ‚Äî SEND OTP ‚îÄ‚îÄ
window.doSendOTP = async () => {
    const code  = document.getElementById('r-code').value.trim() || '+27';
    let   phone = document.getElementById('r-phone').value.trim().replace(/\s/g,'');

    if (!phone) { msg('r3-msg','Please enter your phone number.','err'); return; }

    // SA number cleanup: remove leading 0 if present
    if (phone.startsWith('0')) phone = phone.substring(1);

    // Validate SA mobile numbers (8 digits after removing leading 0)
    if (code === '+27' && phone.length !== 9) {
        msg('r3-msg','Enter a valid SA number e.g. 0812345678','err');
        return;
    }

    const fullPhone = code + phone;
    regData.phone   = fullPhone;

    setBtn('r3-btn', true, 'Send Verification Code');
    msg('r3-msg','','');

    try {
        // Check if phone already used free trial
        const q    = query(collection(db,'users'), where('phone','==',fullPhone), where('usedFreeTrial','==',true));
        const snap = await getDocs(q);
        if (!snap.empty) {
            msg('r3-msg','This number already used a free trial. Please pay R10 to continue.','err');
            setBtn('r3-btn', false, 'Send Verification Code');
            return;
        }

        // Setup invisible recaptcha
        if (window.recaptchaVerifier) {
            try { window.recaptchaVerifier.clear(); } catch(e) {}
        }
        window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
            size: 'invisible',
            callback: () => {}
        });

        confirmResult = await signInWithPhoneNumber(auth, fullPhone, window.recaptchaVerifier);

        document.getElementById('otp-sub').textContent = `We sent a 6-digit code to ${fullPhone}`;
        show('s-otp');
        document.getElementById('o1').focus();
        startOTPTimer();
        setBtn('r3-btn', false, 'Send Verification Code');

    } catch(e) {
        console.error('OTP error:', e);
        const m = {
            'auth/invalid-phone-number':    'Invalid phone number. Use format: 0812345678',
            'auth/too-many-requests':       'Too many attempts. Please wait a few minutes.',
            'auth/quota-exceeded':          'SMS quota exceeded. Try again later.',
            'auth/captcha-check-failed':    'Verification failed. Please try again.'
        };
        msg('r3-msg', m[e.code]||`Error: ${e.message}`, 'err');
        setBtn('r3-btn', false, 'Send Verification Code');
        try { window.recaptchaVerifier.clear(); } catch(ex){}
        window.recaptchaVerifier = null;
    }
};

// ‚îÄ‚îÄ VERIFY OTP + CREATE ACCOUNT ‚îÄ‚îÄ
window.doVerifyOTP = async () => {
    const otp = ['o1','o2','o3','o4','o5','o6'].map(id=>document.getElementById(id).value).join('');
    if (otp.length < 6) { msg('otp-msg','Please enter all 6 digits.','err'); return; }
    if (!confirmResult)  { msg('otp-msg','Session expired. Go back and resend code.','err'); return; }

    setBtn('otp-btn', true, 'Verify & Create Account');
    msg('otp-msg','','');

    try {
        // 1. Verify OTP
        await confirmResult.confirm(otp);

        // 2. Create email account
        const cred = await createUserWithEmailAndPassword(auth, regData.email, regData.pass);
        await updateProfile(cred.user, { displayName: regData.name });

        // 3. Generate token + set free expiry
        const token      = crypto.randomUUID();
        const freeExpiry = new Date(Date.now() + 3*60*60*1000).toISOString();

        const userData = {
            name:          regData.name,
            email:         regData.email,
            phone:         regData.phone,
            token:         token,
            balance:       0,
            subscribed:    true,
            usedFreeTrial: true,
            freeExpiry:    freeExpiry,
            isFree:        true,
            createdAt:     new Date().toISOString(),
            history:       []
        };

        // 4. Save to Firestore
        await setDoc(doc(db,'users', cred.user.uid), userData);

        // 5. Save locally for offline access
        try {
            localStorage.setItem('nmedea_session', JSON.stringify({
                uid:         cred.user.uid,
                token:       token,
                freeExpiry:  freeExpiry,
                subscribed:  true,
                name:        regData.name,
                email:       regData.email
            }));
        } catch(e) {}

        show('s-success');

    } catch(e) {
        console.error('Verify error:', e);
        const m = {
            'auth/invalid-verification-code': 'Wrong code. Please try again.',
            'auth/code-expired':              'Code expired. Go back and request a new one.',
            'auth/email-already-in-use':      'This email is already registered. Please sign in.'
        };
        msg('otp-msg', m[e.code]||`Error: ${e.message}`, 'err');
        setBtn('otp-btn', false, 'Verify & Create Account');
    }
};

// ‚îÄ‚îÄ FORGOT PASSWORD ‚îÄ‚îÄ
window.doForgot = async () => {
    const email = document.getElementById('f-email').value.trim();
    if (!email) { msg('f-msg','Please enter your email.','err'); return; }
    setBtn('f-btn', true, 'Send Reset Link');
    try {
        await sendPasswordResetEmail(auth, email);
        msg('f-msg','‚úì Reset link sent! Check your inbox.','ok');
    } catch(e) {
        msg('f-msg','Could not send reset link. Check your email.','err');
    }
    setBtn('f-btn', false, 'Send Reset Link');
};
</script>

</body>
</html>
