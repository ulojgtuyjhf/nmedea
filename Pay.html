<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nmedea — Add Funds</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:opsz,wght@9..40,400;9..40,700&display=swap" rel="stylesheet">
    <script src="https://js.yoco.com/sdk/v1/yoco-sdk-web.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'DM Sans', sans-serif;
            background: #0b0b0b; color: #f3f3ee;
            min-height: 100dvh;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 20px; padding: 24px;
        }
        .logo { font-family:'Bebas Neue',sans-serif; font-size:28px; letter-spacing:4px; }
        .amt  { font-family:'Bebas Neue',sans-serif; font-size:64px; letter-spacing:2px; }
        .lbl  { font-size:12px; letter-spacing:2px; text-transform:uppercase; color:rgba(243,243,238,.4); margin-top:-12px; }
        .btn  {
            width:100%; max-width:320px; padding:16px;
            background:#f3f3ee; color:#0b0b0b;
            border:none; border-radius:10px;
            font-family:'DM Sans',sans-serif; font-size:14px;
            font-weight:800; letter-spacing:2px; text-transform:uppercase; cursor:pointer;
        }
        .btn-cancel {
            background:transparent; color:rgba(243,243,238,.4);
            border:1px solid rgba(243,243,238,.1); margin-top:-6px;
        }
        .msg { font-size:14px; text-align:center; min-height:20px; }
        .msg.ok  { color:#22c55e; }
        .msg.err { color:#ef4444; }
    </style>
</head>
<body>
    <div class="logo">nmedea</div>
    <div class="amt" id="displayAmt">R10</div>
    <div class="lbl">Add to balance</div>
    <button class="btn" id="payBtn">Pay Now</button>
    <button class="btn btn-cancel" onclick="location.href='dashboard.html'">Cancel</button>
    <div class="msg" id="msg"></div>

<script type="module">
    import { initializeApp }
        from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged }
        from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, doc, updateDoc, arrayUnion, increment }
        from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const app  = initializeApp({
        apiKey:            "AIzaSyBreKi86gv26Eig7hym4WFhAB70VbVWW5g",
        authDomain:        "checkers-225fb.firebaseapp.com",
        projectId:         "checkers-225fb",
        storageBucket:     "checkers-225fb.firebasestorage.app",
        messagingSenderId: "75322611034",
        appId:             "1:75322611034:web:d3725be1ae7b640b408f63"
    });
    const auth = getAuth(app);
    const db   = getFirestore(app);

    var yoco = new YocoSDK({ publicKey: 'pk_live_3fa50d60wE6ZogWa2474' });

    var params = new URLSearchParams(location.search);
    var amt    = parseInt(params.get('amt')) || 10;
    document.getElementById('displayAmt').textContent = 'R' + amt;

    var currentUser = null;
    onAuthStateChanged(auth, user => {
        if (!user) { location.replace('index.html'); return; }
        currentUser = user;
        document.getElementById('payBtn').click();
    });

    document.getElementById('payBtn').addEventListener('click', function() {
        if (!currentUser) return;
        yoco.showPopup({
            amountInCents: amt * 100,
            currency: 'ZAR',
            name: 'nmedea',
            description: 'Add R' + amt + ' to balance',
            callback: async function(result) {
                if (result.error) {
                    location.href = 'dashboard.html';
                    return;
                }
                document.getElementById('msg').textContent = 'Processing...';
                document.getElementById('msg').className  = 'msg';
                try {
                    const resp = await fetch('https://yoco-backend-h0oh3kdt8-nmedea074-9413s-projects.vercel.app/api/charge', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: result.id, amountInCents: amt * 100 })
                    });
                    const data = await resp.json();
                    if (data.status === 'successful') {
                        await updateDoc(doc(db, 'users', currentUser.uid), {
                            balance: increment(amt),
                            history: arrayUnion({
                                type: 'deposit',
                                amount: amt,
                                time: new Date().toISOString()
                            })
                        });
                        document.getElementById('msg').textContent = '✓ R' + amt + ' added!';
                        document.getElementById('msg').className   = 'msg ok';
                        setTimeout(() => { location.href = 'dashboard.html'; }, 1500);
                    } else {
                        document.getElementById('msg').textContent = 'Payment failed. Try again.';
                        document.getElementById('msg').className   = 'msg err';
                    }
                } catch(e) {
                    document.getElementById('msg').textContent = 'Connection error. Try again.';
                    document.getElementById('msg').className   = 'msg err';
                }
            }
        });
    });
</script>
</body>
</html>
